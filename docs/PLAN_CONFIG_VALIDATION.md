# Plan: Ensure config.txt Contains Mandatory Parameters + UX Improvements

## Problem Statement
The config.txt generated by the tool doesn't work on the VTAP reader because:
1. **`KBLogMode` was not set at all** - this setting must be present for keyboard output
2. **User forgot to save the keyboard form** - forms require explicit save, but there's no warning when leaving unsaved

## Research Findings

### Mandatory Header
- `!VTAPconfig` - must be the first line of every config.txt

### Apple VAS - Mandatory Parameters
Per official documentation:
- **`VAS#MerchantID`** - Required (pass type ID, e.g., `pass.com.company.app`)
- **`VAS#KeySlot`** - Required (1-6, specifies which key slot contains the private key)

**Current Issue**: In [vas.py:84-85](src/vtap100/models/vas.py#L84-L85), `VAS#KeySlot` is only output if `key_slot > 0`. With default `key_slot=0`, the line is omitted entirely.

**Decision**: Disallow `key_slot=0` - require explicit 1-6.

### Google Smart Tap - Mandatory Parameters
Per official documentation:
- **`ST#CollectorID`** - Required (8-digit Google Collector ID)
- **`ST#KeySlot`** - Required for authentication (1-6)
- **`ST#KeyVersion`** - Required for authentication (must match Google dashboard)

**Current Issue**: In [smarttap.py:68-72](src/vtap100/models/smarttap.py#L68-L72), both `ST#KeySlot` and `ST#KeyVersion` are only output if > 0. The Jinja template also conditionally includes key_version.

**Decision**: Disallow `key_slot=0` - require explicit 1-6.

### Keyboard Emulation - For Output to Work
- **`KBLogMode=1`** - Required to enable keyboard output (default is 0 = disabled)
- **This setting MUST be present** in the config for the reader to work

**Current State**: In [keyboard.py:47-48](src/vtap100/models/keyboard.py#L47-L48), `log_mode` defaults to `False`, meaning `KBLogMode=0` is output (disabled).

**Root Cause**: The keyboard form wasn't saved, so `KBLogMode` wasn't in the config at all.

### UX Issue: No Warning When Leaving Unsaved Forms
- Forms require clicking "Save" button to persist changes to memory
- When user switches sections (clicks different sidebar item), form changes are silently lost
- User discovered this the hard way by forgetting to save the keyboard form

**Decision**: Show confirmation dialog when leaving a form with unsaved changes.

### Minimum Working Examples

**Apple VAS only:**
```
!VTAPconfig
VAS1MerchantID=pass.com.example.myapp
VAS1KeySlot=1
```

**Google Smart Tap:**
```
!VTAPconfig
ST1CollectorID=12345678
ST1KeySlot=2
ST1KeyVersion=1
```

**Combined with Keyboard Output:**
```
!VTAPconfig
VAS1MerchantID=pass.com.example.myapp
VAS1KeySlot=1
KBLogMode=1
```

---

## Implementation Plan

### Part A: Mandatory Config Parameters

#### A1. Update Model Validation (require key_slot 1-6)

**File: [src/vtap100/models/vas.py](src/vtap100/models/vas.py)**
- Change `key_slot` field: `ge=1` instead of `ge=0`
- Update `to_config_lines()` to always output `VAS#KeySlot`

**File: [src/vtap100/models/smarttap.py](src/vtap100/models/smarttap.py)**
- Change `key_slot` field: `ge=1` instead of `ge=0`
- Update `to_config_lines()` to always output `ST#KeySlot` and `ST#KeyVersion`

**File: [src/vtap100/generator.py](src/vtap100/generator.py)**
- Update Jinja template to always include `ST#KeyVersion`

#### A2. Add Config Validation Warnings

**File: [src/vtap100/models/config.py](src/vtap100/models/config.py)**
- Add `validate_for_device() -> list[str]` method returning warnings:
  - VAS without key_slot 1-6
  - SmartTap without key_slot 1-6 or key_version
  - Keyboard config present but log_mode=False
- Show warnings before export (allow but warn)

#### A3. Update TUI Forms

**Files: [src/vtap100/tui/widgets/forms/vas.py](src/vtap100/tui/widgets/forms/vas.py), [smarttap.py](src/vtap100/tui/widgets/forms/smarttap.py)**
- Remove "Auto (0)" option from key_slot Select widget
- Only show slots 1-6

#### A4. Update CLI

**File: [src/vtap100/cli.py](src/vtap100/cli.py)**
- Add validation warnings before generating config

---

### Part B: UX - Unsaved Changes Warning Dialog

#### B1. Add Per-Form Dirty State Tracking

**File: [src/vtap100/tui/widgets/forms/base.py](src/vtap100/tui/widgets/forms/base.py)**
- Add `_initial_values: dict` to store form state when loaded
- Add `is_dirty: bool` property comparing current values to initial
- Add `mark_saved()` method to reset dirty state after save
- Call `mark_saved()` in save button handler after success

#### B2. Create Unsaved Changes Dialog

**New File: [src/vtap100/tui/screens/unsaved_changes_dialog.py](src/vtap100/tui/screens/unsaved_changes_dialog.py)**
- Modal dialog with three buttons: "Save" / "Discard" / "Cancel"
- Returns enum: `UnsavedChangesResult.SAVE | DISCARD | CANCEL`
- Bilingual support (DE/EN)

#### B3. Intercept Section Navigation

**File: [src/vtap100/tui/screens/editor.py](src/vtap100/tui/screens/editor.py)**
- In `on_section_selected()`: Check if current form `is_dirty` before navigation
- If dirty: Push `UnsavedChangesDialog`
- Handle result:
  - SAVE → Save form, then navigate
  - DISCARD → Navigate without saving
  - CANCEL → Stay on current form

---

## Files to Modify

| File | Changes |
|------|---------|
| [src/vtap100/models/vas.py](src/vtap100/models/vas.py) | Require key_slot 1-6, always output |
| [src/vtap100/models/smarttap.py](src/vtap100/models/smarttap.py) | Require key_slot 1-6, always output KeyVersion |
| [src/vtap100/models/config.py](src/vtap100/models/config.py) | Add `validate_for_device()` warnings |
| [src/vtap100/generator.py](src/vtap100/generator.py) | Update Jinja template |
| [src/vtap100/tui/widgets/forms/base.py](src/vtap100/tui/widgets/forms/base.py) | Add dirty state tracking |
| [src/vtap100/tui/widgets/forms/vas.py](src/vtap100/tui/widgets/forms/vas.py) | Remove Auto(0) option |
| [src/vtap100/tui/widgets/forms/smarttap.py](src/vtap100/tui/widgets/forms/smarttap.py) | Remove Auto(0) option |
| [src/vtap100/tui/screens/editor.py](src/vtap100/tui/screens/editor.py) | Check dirty before navigation |
| [src/vtap100/tui/screens/unsaved_changes_dialog.py](src/vtap100/tui/screens/unsaved_changes_dialog.py) | **NEW** - Dialog |
| [src/vtap100/cli.py](src/vtap100/cli.py) | Add validation warnings |
| tests/unit/* | Tests for validation + dirty tracking |

---

## Test Plan

1. **Model tests**: Verify key_slot=0 is rejected with ValidationError
2. **Config generation tests**: Verify all required fields always output
3. **Dirty tracking tests**: Verify form detects changes correctly
4. **Dialog tests**: Verify navigation blocked when dirty, correct result handling
5. **Integration**: Generate config, verify it works on physical reader
